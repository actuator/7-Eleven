# Using Frida to Hook & Modify the "Hello Message Cup" Application

The following is a turnkey guide to using Frida as an alternative to patching the "Hello Cup" application by modifying the `filterTrash` method.

I have chosen to use a Nexus 6 device as they are easy to root and a Kali Linux machine in order to demonstrate this process.

*Note: Due to the scarcity of these promotional LED Cups this is virtually impossible & impractical to exploit. If anyone should be offended by this guide it's me as I am **Black**-this was just an interesting learning exercise.*


Addionally the original application has been pulled from the Android Play Store.

You can locate the original APK on APKPure at https://apkpure.com/hello-cup/ble.co.madlife.www/downloading

**Table of Contents**

- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
- [Setup Steps](#setup-steps)
  - [1. Setting Up Frida on Kali Linux](#1-setting-up-frida-on-kali-linux)
    - [1.1 Update Package Lists](#11-update-package-lists)
    - [1.2 Install Python 3 and pip3](#12-install-python-3-and-pip3)
    - [1.3 Install Python Virtual Environment Tools](#13-install-python-virtual-environment-tools)
    - [1.4 Create a Virtual Environment for Frida](#14-create-a-virtual-environment-for-frida)
    - [1.5 Upgrade pip in the Virtual Environment](#15-upgrade-pip-in-the-virtual-environment)
    - [1.6 Install Frida and Frida Tools](#16-install-frida-and-frida-tools)
    - [1.7 Verify Frida Installation](#17-verify-frida-installation)
  - [2. Setting Up Frida Server on Nexus 6](#2-setting-up-frida-server-on-nexus-6)
    - [2.1 Install ADB on Kali Linux](#21-install-adb-on-kali-linux)
    - [2.2 Enable USB Debugging on Nexus 6](#22-enable-usb-debugging-on-nexus-6)
    - [2.3 Connect Nexus 6 to Kali Linux via USB](#23-connect-nexus-6-to-kali-linux-via-usb)
    - [2.4 Verify ADB Connection](#24-verify-adb-connection)
    - [2.5 Download Matching `frida-server`](#25-download-matching-frida-server)
    - [2.6 Extract and Prepare `frida-server`](#26-extract-and-prepare-frida-server)
    - [2.7 Transfer the `frida-server` to Your Nexus 6 Phone](#27-transfer-the-frida-server-to-your-nexus-6-phone)
    - [2.8 Set Permissions and Start `frida-server` on Nexus 6](#28-set-permissions-and-start-frida-server-on-nexus-6)
  - [3. Verifying the Frida Setup](#3-verifying-the-frida-setup)
    - [3.1 Forward Frida's Port via ADB](#31-forward-fridas-port-via-adb)
    - [3.2 Test Frida Connection](#32-test-frida-connection)
- [Hooking the `filterTrash` Method](#hooking-the-filtertrash-method)
  - [1. Understanding the Target Method](#1-understanding-the-target-method)
  - [2. Writing the Frida Script](#2-writing-the-frida-script)
    - [2.1 Create a New Frida Script Which Will Function as a Bypass](#21-create-a-new-frida-script-which-will-function-as-a-bypass)
    - [2.2 Add the Following Script](#22-add-the-following-script)
    - [2.3 Save and Exit](#23-save-and-exit)
  - [3. Running the Frida Script](#3-running-the-frida-script)
    - [3.1 Ensure the App is Running on Nexus 6](#31-ensure-the-app-is-running-on-nexus-6)
    - [3.2 Run the Script](#32-run-the-script)
    - [3.3 Expected Output](#33-expected-output)
  - [4. Confirming the Hook](#4-confirming-the-hook)
    - [4.1 Trigger the `filterTrash` Method](#41-trigger-the-filtertrash-method)
    - [4.2 Observe Terminal Output](#42-observe-terminal-output)
    - [4.3 Verify the App Behavior](#43-verify-the-app-behavior)


## Introduction

Frida is a dynamic instrumentation toolkit for security researchers, reverse-engineers, developers & everyone in between. This tool is the main dependency & allows you to inject scripts into native apps on various platforms, but our focus is on Android.

## Prerequisites

- **Kali Linux Machine**
- **Android Device**: A rooted Nexus 6 device with USB debugging enabled.
- **USB Cable**: To connect your Nexus 6 to your Kali Linux machine or via wireless ADB
- **Frida Installed on Kali Linux**
- **Matching `frida-server` on Nexus 6**: The version of `frida-server` must match the Frida version on Kali Linux.
- **Python 3 and pip3** installed on Kali Linux
- **ADB (Android Debug Bridge)** installed on Kali Linux

---

## Setup Steps

### 1. Setting Up Frida on Kali Linux

#### 1.1 Update Package Lists

```bash
sudo apt update
```

#### 1.2 Install Python 3 and pip3

```bash
sudo apt install python3 python3-pip -y
```

#### 1.3 Install Python Virtual Environment Tools

*This is typically required on Kali systems; you may be able to skip this step, but I wanted to keep the guide user-friendly.*

```bash
sudo apt install python3-venv -y
```

#### 1.4 Create a Virtual Environment for Frida

```bash
python3 -m venv ~/frida_env
source ~/frida_env/bin/activate
```

#### 1.5 Upgrade pip in the Virtual Environment

```bash
pip install --upgrade pip
```

#### 1.6 Install Frida and Frida Tools

```bash
pip install frida frida-tools
```

#### 1.7 Verify Frida Installation

```bash
frida --version
```

**Example Output:**

```
16.5.6
```

### 2. Setting Up Frida Server on Nexus 6

#### 2.1 Install ADB on Kali Linux

```bash
sudo apt install android-tools-adb android-tools-fastboot -y
```

#### 2.2 Enable USB Debugging on Nexus 6

- On your Nexus 6:
  - Go to **Settings > About phone**.
  - Tap **Build number** seven times to enable Developer Options.
  - Go back to **Settings** and enter **Developer options**.
  - Enable **USB debugging**.

#### 2.3 Connect Nexus 6 to Kali Linux via USB

- Use a USB cable to connect your Nexus 6 to your Kali Linux machine.

#### 2.4 Verify ADB Connection

```bash
adb devices
```

**Expected Output:**

```
List of devices attached
ZX1G22WB7V	device   // This will change per device
```

#### 2.5 Download Matching `frida-server`

- **Find the Frida version installed on Kali Linux:**

  ```bash
  frida --version
  ```

- **Download `frida-server` for `android-arm` architecture:**

  ```bash
  cd ~/Downloads
  wget https://github.com/frida/frida/releases/download/16.5.6/frida-server-16.5.6-android-arm.xz
  ```

#### 2.6 Extract and Prepare `frida-server`

```bash
unxz frida-server-16.5.6-android-arm.xz
chmod +x frida-server-16.5.6-android-arm
mv frida-server-16.5.6-android-arm frida-server
```

#### 2.7 Transfer the `frida-server` to Your Nexus 6 Phone

```bash
adb push frida-server /data/local/tmp/
```

#### 2.8 Set Permissions and Start `frida-server` on Nexus 6

```bash
adb shell
su
cd /data/local/tmp/
chmod 755 frida-server
./frida-server &
```

- **Verify `frida-server` is running:**

  ```bash
  ps | grep frida-server
  ```

- **Exit ADB shell:**

  ```bash
  exit
  exit
  ```

### 3. Verifying the Frida Setup

#### 3.1 Forward Frida's Port via ADB

```bash
adb forward tcp:27042 tcp:27042
```

#### 3.2 Test Frida Connection

```bash
frida-ps -U
```

**Expected Output:**

```
 PID  Name
----  --------------------------------------------------
1234  Hello Cup
5678  com.android.systemui
...
```

If you see the list of running processes on your Nexus 6-you're on the right path as this indicates Frida is set up correctly.

---

## Hooking the `filterTrash` Method

### 1. Understanding the Target Method

The objective is to hook the `filterTrash` method within the `CommandHelper` class of the app in order to replace the `split` and `split2` arrays with a new word like `["pokemongo"]`.

### 2. Writing the Frida Script

#### 2.1 Create a New Frida Script Which Will Function as a Bypass

```bash
nano script.js
```

#### 2.2 Add the Following Script

```javascript
Java.perform(function () {
    // This will allow us to obtain a reference to the CommandHelper class
    var CommandHelper = Java.use('ble.co.madlife.www.ble.bluetooth.CommandHelper');

    // This will allow Frida to hook the 'filterTrash' method
    CommandHelper.filterTrash.overload('java.lang.String').implementation = function (str) {
        console.log('filterTrash called with argument:', str);

        // Check for null or empty string
        if (str == null || str === "") {
            return str;
        }

        // Override 'split' and 'split2' with ['pokemongo'] or whatever phrase you would like
        var split = ['pokemongo'];
        var split2 = ['pokemongo'];

        // Original code logic with our custom arrays
        var replaceAll = str.replace(/\n+|[\u4e00-\u9fa5]+/g, "");

        // Process 'split' array
        split.forEach(function (word) {
            var pattern = new RegExp("\\b(" + word + "+)([^A-Za-z0-9]*)\\b", "gi");
            replaceAll = replaceAll.replace(pattern, function (match, p1, p2) {
                return '*'.repeat(p1.length) + (p2 || '');
            });
        });

        // Process 'split2' array
        split2.forEach(function (word) {
            var pattern = new RegExp(word + "+", "gi");
            replaceAll = replaceAll.replace(pattern, '*'.repeat(word.length));
        });

        console.log('Filtered result:', replaceAll);
        return replaceAll;
    };
});
```

#### 2.3 Save and Exit

### 3. Running the Frida Script

#### 3.1 Ensure the App is Running on Nexus 6

- Launch the "Hello Cup" app on your device.

#### 3.2 Run the Script

```bash
frida -U -n "Hello Cup" -l script.js 
```

- **Options Explained:**
  - `-U`: Connects to the USB device.
  - `-n "Hello Cup"`: Targets the app by name.
  - `-l script.js`: Loads the script.

#### 3.3 Expected Output

![Screenshot 2024-10-29 175608](https://github.com/user-attachments/assets/4b2ea789-770c-4806-85cb-04ace72d95cc)


### 4. Confirming the Hook

#### 4.1 Trigger the `filterTrash` Method

- In the app attempt to send a message which will invoke `filterTrash`.

#### 4.2 Observe Terminal Output

- You should see logs like:
- ![Screenshot 2024-10-29 175608](https://github.com/user-attachments/assets/d972d2f8-a0dd-4cbc-8aa3-3ad399cae26f)


#### 4.3 Verify the App Behavior

- The word "pokemongo" should be filtered (replaced with asterisks).
- Words from the original `split` and `split2` arrays should not be filtered.


